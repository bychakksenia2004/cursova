{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///D:/magistrature/Dockerwork/kursova/app/api/attempts/%5BtestId%5D/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\r\nimport { connectToDB } from \"../../../../../lib/mongodb\";\r\nimport Attempt from \"../../../../../lib/models/Attempt\";\r\nimport Test from \"../../../../../lib/models/Test\";\r\nimport { getUserFromCookieServer } from \"../../../../../lib/auth\";\r\n\r\nexport async function GET(req: Request, ctx: any) {\r\n  try {\r\n    const params = await ctx.params;\r\n    const testId = params?.testId;\r\n    if (!testId) return NextResponse.json({ error: \"Missing testId\" }, { status: 400 });\r\n    await connectToDB();\r\n\r\n    const user = await getUserFromCookieServer();\r\n    if (!user) return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 });\r\n\r\n    // Ensure requesting user is the author of the test\r\n    const test = await Test.findById(String(testId)).lean();\r\n    if (!test) return NextResponse.json({ error: \"Test not found\" }, { status: 404 });\r\n    if (String(test.authorId) !== String(user._id)) return NextResponse.json({ error: \"Forbidden\" }, { status: 403 });\r\n\r\n    const url = new URL(req.url);\r\n    const userQuery = (url.searchParams.get(\"user\") || \"\").trim().toLowerCase();\r\n\r\n    const attempts = await Attempt.find({ testId: String(testId) }).sort({ createdAt: -1 }).lean();\r\n\r\n    // populate user info (simple lookup)\r\n    const results = await Promise.all(attempts.map(async (a: any) => {\r\n      let username: string | null = null;\r\n      try {\r\n        if (a.userId) {\r\n          // lazy load User to get username\r\n          const User = (await import(\"../../../../../lib/models/User\")).default;\r\n          const u = await User.findById(a.userId).select(\"username\").lean();\r\n          username = u ? (u.username || null) : null;\r\n        }\r\n      } catch (err) {\r\n        username = null;\r\n      }\r\n      return { id: String(a._id), userId: a.userId || null, username: username || \"Анонім\", totalScore: a.totalScore, totalPossible: a.totalPossible, createdAt: a.createdAt, perQuestion: a.perQuestion };\r\n    }));\r\n\r\n    const filtered = userQuery ? results.filter(r => (r.username || \"\").toLowerCase().includes(userQuery)) : results;\r\n\r\n    return NextResponse.json({ ok: true, attempts: filtered }, { status: 200 });\r\n  } catch (err: any) {\r\n    console.error(\"/api/attempts/[testId] GET error:\", err);\r\n    return NextResponse.json({ error: err?.message || String(err) }, { status: 500 });\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;AAMO,eAAe,IAAI,GAAY,EAAE,GAAQ;IAC9C,IAAI;QACF,MAAM,SAAS,MAAM,IAAI,MAAM;QAC/B,MAAM,SAAS,QAAQ;QACvB,IAAI,CAAC,QAAQ,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAiB,GAAG;YAAE,QAAQ;QAAI;QACjF,MAAM;QAEN,MAAM,OAAO,MAAM;QACnB,IAAI,CAAC,MAAM,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAe,GAAG;YAAE,QAAQ;QAAI;QAE7E,mDAAmD;QACnD,MAAM,OAAO,MAAM,KAAK,QAAQ,CAAC,OAAO,SAAS,IAAI;QACrD,IAAI,CAAC,MAAM,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAiB,GAAG;YAAE,QAAQ;QAAI;QAC/E,IAAI,OAAO,KAAK,QAAQ,MAAM,OAAO,KAAK,GAAG,GAAG,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAY,GAAG;YAAE,QAAQ;QAAI;QAE/G,MAAM,MAAM,IAAI,IAAI,IAAI,GAAG;QAC3B,MAAM,YAAY,CAAC,IAAI,YAAY,CAAC,GAAG,CAAC,WAAW,EAAE,EAAE,IAAI,GAAG,WAAW;QAEzE,MAAM,WAAW,MAAM,QAAQ,IAAI,CAAC;YAAE,QAAQ,OAAO;QAAQ,GAAG,IAAI,CAAC;YAAE,WAAW,CAAC;QAAE,GAAG,IAAI;QAE5F,qCAAqC;QACrC,MAAM,UAAU,MAAM,QAAQ,GAAG,CAAC,SAAS,GAAG,CAAC,OAAO;YACpD,IAAI,WAA0B;YAC9B,IAAI;gBACF,IAAI,EAAE,MAAM,EAAE;oBACZ,iCAAiC;oBACjC,MAAM,OAAO,CAAC;;;;wBAA8C,EAAE,OAAO;oBACrE,MAAM,IAAI,MAAM,KAAK,QAAQ,CAAC,EAAE,MAAM,EAAE,MAAM,CAAC,YAAY,IAAI;oBAC/D,WAAW,IAAK,EAAE,QAAQ,IAAI,OAAQ;gBACxC;YACF,EAAE,OAAO,KAAK;gBACZ,WAAW;YACb;YACA,OAAO;gBAAE,IAAI,OAAO,EAAE,GAAG;gBAAG,QAAQ,EAAE,MAAM,IAAI;gBAAM,UAAU,YAAY;gBAAU,YAAY,EAAE,UAAU;gBAAE,eAAe,EAAE,aAAa;gBAAE,WAAW,EAAE,SAAS;gBAAE,aAAa,EAAE,WAAW;YAAC;QACrM;QAEA,MAAM,WAAW,YAAY,QAAQ,MAAM,CAAC,CAAA,IAAK,CAAC,EAAE,QAAQ,IAAI,EAAE,EAAE,WAAW,GAAG,QAAQ,CAAC,cAAc;QAEzG,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,IAAI;YAAM,UAAU;QAAS,GAAG;YAAE,QAAQ;QAAI;IAC3E,EAAE,OAAO,KAAU;QACjB,QAAQ,KAAK,CAAC,qCAAqC;QACnD,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO,KAAK,WAAW,OAAO;QAAK,GAAG;YAAE,QAAQ;QAAI;IACjF;AACF"}}]
}