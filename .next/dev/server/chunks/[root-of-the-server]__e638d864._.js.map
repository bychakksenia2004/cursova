{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 64, "column": 0}, "map": {"version":3,"sources":["file:///D:/magistrature/Dockerwork/kursova/lib/mongodb.ts"],"sourcesContent":["import mongoose from \"mongoose\";\r\nimport dns from \"dns/promises\";\r\n\r\n// Додаємо константу з fallback на MONGODB_URI\r\nconst MONGODB_URL = process.env.MONGODB_URL || process.env.MONGODB_URI;\r\n\r\nif (!MONGODB_URL) {\r\n  throw new Error(\"❌ Вкажи змінну MONGODB_URL або MONGODB_URI у .env.local\");\r\n}\r\n\r\nlet cached = (global as any).mongoose;\r\n\r\nif (!cached) {\r\n  cached = (global as any).mongoose = { conn: null, promise: null };\r\n}\r\n\r\nexport async function connectToDB(): Promise<typeof mongoose> {\r\n  if (cached.conn) return cached.conn;\r\n\r\n  if (!cached.promise) {\r\n    // Більші таймаути для більш стабільної діагностики\r\n    cached.promise = mongoose\r\n      .connect(MONGODB_URL as string, {\r\n        // сучасні mongoose/driver опції за замовчуванням працюють добре,\r\n        // але додаємо час очікування на вибір сервера для швидшої діагностики\r\n        serverSelectionTimeoutMS: 10000,\r\n        connectTimeoutMS: 10000,\r\n        socketTimeoutMS: 45000\r\n      })\r\n      .then((mongoose) => mongoose)\r\n      .catch(async (err) => {\r\n        // Лог оригінальної помилки на сервері (щоб бачити стек)\r\n        console.error(\"MongoDB connection error (original):\", err);\r\n\r\n        // Базове дружнє повідомлення\r\n        let diag = [\r\n          \"Не вдалося підключитися до MongoDB.\",\r\n          \"Перевірте MONGODB_URL у d:\\\\magistrature\\\\Dockerwork\\\\kursova\\\\.env.local,\",\r\n          \"переконайтесь, що кластер працює, та що ваш IP добавлений в Network Access (whitelist) в Atlas.\",\r\n          `Оригінальна помилка: ${err?.message ?? String(err)}`\r\n        ].join(\" \");\r\n\r\n        // Додаткова діагностика для mongodb+srv (DNS SRV)\r\n        try {\r\n          if (typeof MONGODB_URL === \"string\" && MONGODB_URL.startsWith(\"mongodb+srv://\")) {\r\n            try {\r\n              const parsed = new URL(MONGODB_URL);\r\n              const host = parsed.hostname;\r\n              diag += ` SRV host: ${host}.`;\r\n\r\n              try {\r\n                const srv = await dns.resolveSrv(`_mongodb._tcp.${host}`);\r\n                diag += ` DNS SRV records: ${JSON.stringify(srv)}.`;\r\n              } catch (srvErr) {\r\n                diag += ` DNS SRV lookup failed: ${srvErr?.message ?? String(srvErr)}.`;\r\n              }\r\n\r\n              try {\r\n                const lookup = await dns.lookup(host);\r\n                diag += ` DNS lookup: ${JSON.stringify(lookup)}.`;\r\n              } catch (lookupErr) {\r\n                diag += ` DNS lookup failed: ${lookupErr?.message ?? String(lookupErr)}.`;\r\n              }\r\n            } catch (parseErr) {\r\n              diag += ` Failed to parse URL for additional diagnostics: ${parseErr?.message ?? String(parseErr)}.`;\r\n            }\r\n          } else {\r\n            // Для звичайних mongodb:// хостів також можна зробити dns.lookup\r\n            try {\r\n              const parsed = new URL(MONGODB_URL as string);\r\n              const host = parsed.hostname;\r\n              try {\r\n                const lookup = await dns.lookup(host);\r\n                diag += ` DNS lookup: ${JSON.stringify(lookup)}.`;\r\n              } catch (lookupErr) {\r\n                diag += ` DNS lookup failed: ${lookupErr?.message ?? String(lookupErr)}.`;\r\n              }\r\n            } catch {\r\n              // нічого\r\n            }\r\n          }\r\n        } catch (diagErr) {\r\n          diag += ` (diagnostics failed: ${diagErr?.message ?? String(diagErr)})`;\r\n        }\r\n\r\n        // Кидаємо нову помилку з детальною діагностикою\r\n        throw new Error(diag);\r\n      });\r\n  }\r\n\r\n  cached.conn = await cached.promise;\r\n  return cached.conn;\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAEA,8CAA8C;AAC9C,MAAM,cAAc,QAAQ,GAAG,CAAC,WAAW,IAAI,QAAQ,GAAG,CAAC,WAAW;AAEtE,IAAI,CAAC,aAAa;IAChB,MAAM,IAAI,MAAM;AAClB;AAEA,IAAI,SAAS,yDAAgB,QAAQ;AAErC,IAAI,CAAC,QAAQ;IACX,SAAS,yDAAgB,QAAQ,GAAG;QAAE,MAAM;QAAM,SAAS;IAAK;AAClE;AAEO,eAAe;IACpB,IAAI,OAAO,IAAI,EAAE,OAAO,OAAO,IAAI;IAEnC,IAAI,CAAC,OAAO,OAAO,EAAE;QACnB,mDAAmD;QACnD,OAAO,OAAO,GAAG,oHAAQ,CACtB,OAAO,CAAC,aAAuB;YAC9B,iEAAiE;YACjE,sEAAsE;YACtE,0BAA0B;YAC1B,kBAAkB;YAClB,iBAAiB;QACnB,GACC,IAAI,CAAC,CAAC,WAAa,UACnB,KAAK,CAAC,OAAO;YACZ,wDAAwD;YACxD,QAAQ,KAAK,CAAC,wCAAwC;YAEtD,6BAA6B;YAC7B,IAAI,OAAO;gBACT;gBACA;gBACA;gBACA,CAAC,qBAAqB,EAAE,KAAK,WAAW,OAAO,MAAM;aACtD,CAAC,IAAI,CAAC;YAEP,kDAAkD;YAClD,IAAI;gBACF,IAAI,OAAO,gBAAgB,YAAY,YAAY,UAAU,CAAC,mBAAmB;oBAC/E,IAAI;wBACF,MAAM,SAAS,IAAI,IAAI;wBACvB,MAAM,OAAO,OAAO,QAAQ;wBAC5B,QAAQ,CAAC,WAAW,EAAE,KAAK,CAAC,CAAC;wBAE7B,IAAI;4BACF,MAAM,MAAM,MAAM,kIAAG,CAAC,UAAU,CAAC,CAAC,cAAc,EAAE,MAAM;4BACxD,QAAQ,CAAC,kBAAkB,EAAE,KAAK,SAAS,CAAC,KAAK,CAAC,CAAC;wBACrD,EAAE,OAAO,QAAQ;4BACf,QAAQ,CAAC,wBAAwB,EAAE,QAAQ,WAAW,OAAO,QAAQ,CAAC,CAAC;wBACzE;wBAEA,IAAI;4BACF,MAAM,SAAS,MAAM,kIAAG,CAAC,MAAM,CAAC;4BAChC,QAAQ,CAAC,aAAa,EAAE,KAAK,SAAS,CAAC,QAAQ,CAAC,CAAC;wBACnD,EAAE,OAAO,WAAW;4BAClB,QAAQ,CAAC,oBAAoB,EAAE,WAAW,WAAW,OAAO,WAAW,CAAC,CAAC;wBAC3E;oBACF,EAAE,OAAO,UAAU;wBACjB,QAAQ,CAAC,iDAAiD,EAAE,UAAU,WAAW,OAAO,UAAU,CAAC,CAAC;oBACtG;gBACF,OAAO;oBACL,iEAAiE;oBACjE,IAAI;wBACF,MAAM,SAAS,IAAI,IAAI;wBACvB,MAAM,OAAO,OAAO,QAAQ;wBAC5B,IAAI;4BACF,MAAM,SAAS,MAAM,kIAAG,CAAC,MAAM,CAAC;4BAChC,QAAQ,CAAC,aAAa,EAAE,KAAK,SAAS,CAAC,QAAQ,CAAC,CAAC;wBACnD,EAAE,OAAO,WAAW;4BAClB,QAAQ,CAAC,oBAAoB,EAAE,WAAW,WAAW,OAAO,WAAW,CAAC,CAAC;wBAC3E;oBACF,EAAE,OAAM;oBACN,SAAS;oBACX;gBACF;YACF,EAAE,OAAO,SAAS;gBAChB,QAAQ,CAAC,sBAAsB,EAAE,SAAS,WAAW,OAAO,SAAS,CAAC,CAAC;YACzE;YAEA,gDAAgD;YAChD,MAAM,IAAI,MAAM;QAClB;IACJ;IAEA,OAAO,IAAI,GAAG,MAAM,OAAO,OAAO;IAClC,OAAO,OAAO,IAAI;AACpB"}},
    {"offset": {"line": 155, "column": 0}, "map": {"version":3,"sources":["file:///D:/magistrature/Dockerwork/kursova/lib/models/User.ts"],"sourcesContent":["import mongoose, { Document, Model } from \"mongoose\";\r\n\r\nexport interface IUser extends Document {\r\n  username: string;\r\n  email: string;\r\n  password: string;\r\n}\r\n\r\nconst UserSchema = new mongoose.Schema<IUser>(\r\n  {\r\n    email: { type: String, required: true, unique: true },\r\n    username: { type: String, required: true },\r\n    password: { type: String, required: true }\r\n  }\r\n);\r\n\r\nconst User: Model<IUser> = mongoose.models.User || mongoose.model<IUser>(\"User\", UserSchema);\r\nexport default User;\r\n"],"names":[],"mappings":";;;;AAAA;;AAQA,MAAM,aAAa,IAAI,oHAAQ,CAAC,MAAM,CACpC;IACE,OAAO;QAAE,MAAM;QAAQ,UAAU;QAAM,QAAQ;IAAK;IACpD,UAAU;QAAE,MAAM;QAAQ,UAAU;IAAK;IACzC,UAAU;QAAE,MAAM;QAAQ,UAAU;IAAK;AAC3C;AAGF,MAAM,OAAqB,oHAAQ,CAAC,MAAM,CAAC,IAAI,IAAI,oHAAQ,CAAC,KAAK,CAAQ,QAAQ;uCAClE"}},
    {"offset": {"line": 182, "column": 0}, "map": {"version":3,"sources":["file:///D:/magistrature/Dockerwork/kursova/app/api/login/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\r\nimport bcrypt from \"bcryptjs\";\r\nimport { connectToDB } from \"../../../lib/mongodb\";\r\nimport User from \"../../../lib/models/User\";\r\nimport crypto from \"crypto\";\r\n\r\n// helper: base64url\r\nfunction base64url(input: Buffer | string) {\r\n\tconst b = typeof input === \"string\" ? Buffer.from(input) : input;\r\n\treturn b.toString(\"base64\").replace(/\\+/g, \"-\").replace(/\\//g, \"_\").replace(/=+$/, \"\");\r\n}\r\n\r\n// create simple HS256 JWT\r\nfunction createToken(payload: Record<string, any>, secret: string, expiresInSec = 7 * 24 * 3600) {\r\n\tconst header = { alg: \"HS256\", typ: \"JWT\" };\r\n\tconst now = Math.floor(Date.now() / 1000);\r\n\tconst body = { ...payload, iat: now, exp: now + expiresInSec };\r\n\tconst headerB = base64url(JSON.stringify(header));\r\n\tconst payloadB = base64url(JSON.stringify(body));\r\n\tconst toSign = `${headerB}.${payloadB}`;\r\n\tconst sig = crypto.createHmac(\"sha256\", secret).update(toSign).digest();\r\n\tconst sigB = base64url(sig);\r\n\treturn `${toSign}.${sigB}`;\r\n}\r\n\r\n// verify token (returns payload or null)\r\nfunction verifyToken(token: string, secret: string) {\r\n\ttry {\r\n\t\tconst [headerB, payloadB, sigB] = token.split(\".\");\r\n\t\tif (!headerB || !payloadB || !sigB) return null;\r\n\t\tconst toSign = `${headerB}.${payloadB}`;\r\n\t\tconst expectedSig = base64url(crypto.createHmac(\"sha256\", secret).update(toSign).digest());\r\n\t\tif (expectedSig !== sigB) return null;\r\n\t\tconst payload = JSON.parse(Buffer.from(payloadB, \"base64\").toString(\"utf8\"));\r\n\t\tif (payload.exp && Math.floor(Date.now() / 1000) > payload.exp) return null;\r\n\t\treturn payload;\r\n\t} catch {\r\n\t\treturn null;\r\n\t}\r\n}\r\n\r\nexport async function POST(req: Request) {\r\n\ttry {\r\n\t\tconst body = await req.json();\r\n\t\tconst { email: rawEmail, password } = body || {};\r\n\r\n\t\tif (!rawEmail || !password) {\r\n\t\t\treturn NextResponse.json({ error: \"Missing fields\" }, { status: 400 });\r\n\t\t}\r\n\r\n\t\tconst email = String(rawEmail).trim().toLowerCase();\r\n\r\n\t\tawait connectToDB();\r\n\r\n\t\tconst user = await User.findOne({ email }).lean();\r\n\r\n\t\tif (!user) {\r\n\t\t\t// don't reveal whether email exists\r\n\t\t\treturn NextResponse.json({ error: \"Invalid email or password\" }, { status: 401 });\r\n\t\t}\r\n\r\n\t\t// Support both possible field names (password or passwordHash)\r\n\t\tconst hash = (user as any).password ?? (user as any).passwordHash ?? null;\r\n\r\n\t\tif (!hash) {\r\n\t\t\t// server-side info for debugging\r\n\t\t\tconsole.error(`[auth] user ${user._id} has no password hash stored`);\r\n\t\t\treturn NextResponse.json({ error: \"Invalid email or password\" }, { status: 401 });\r\n\t\t}\r\n\r\n\t\t// debug log only in non-production to help you trace issues\r\n\t\tif (process.env.NODE_ENV !== \"production\") {\r\n\t\t\tconsole.debug(`[auth] login attempt`, { userId: String(user._id), hashPresent: !!hash });\r\n\t\t}\r\n\r\n\t\tconst isValid = await bcrypt.compare(password, hash);\r\n\t\tif (!isValid) {\r\n\t\t\treturn NextResponse.json({ error: \"Invalid email or password\" }, { status: 401 });\r\n\t\t}\r\n\r\n\t\t// successful — return minimal info\r\n\t\tconst JWT_SECRET = process.env.JWT_SECRET;\r\n\t\tconst headers: Record<string, string> = { \"Content-Type\": \"application/json\" };\r\n\t\tlet debugSetCookie: string | null = null;\r\n\r\n\t\tif (JWT_SECRET) {\r\n\t\t\tconst token = createToken({ sub: String(user._id), email: user.email }, JWT_SECRET, 7 * 24 * 3600);\r\n\t\t\tconst secure = process.env.NODE_ENV === \"production\";\r\n\t\t\tconst maxAge = 7 * 24 * 3600;\r\n\t\t\t// use SameSite=None if you suspect cross-site; keep Lax otherwise\r\n\t\t\tconst cookie = `token=${token}; HttpOnly; Path=/; Max-Age=${maxAge}; SameSite=Lax${secure ? \"; Secure\" : \"\"}`;\r\n\t\t\theaders[\"Set-Cookie\"] = cookie;\r\n\t\t\tdebugSetCookie = cookie;\r\n\r\n\t\t\t// log for server-side debugging\r\n\t\t\tconsole.log(\"POST /api/login - Set-Cookie:\", cookie);\r\n\t\t} else {\r\n\t\t\tconsole.warn(\"POST /api/login - JWT_SECRET not set — no cookie will be issued\");\r\n\t\t}\r\n\r\n\t\t// include debugSetCookie in response only in non-production to diagnose\r\n\t\tconst bodyResp: any = { ok: true, id: user._id };\r\n\t\tif (process.env.NODE_ENV !== \"production\") {\r\n\t\t\tbodyResp.debugSetCookie = debugSetCookie;\r\n\t\t}\r\n\r\n\t\treturn new NextResponse(JSON.stringify(bodyResp), {\r\n\t\t\tstatus: 200,\r\n\t\t\theaders\r\n\t\t});\r\n\t} catch (err: any) {\r\n\t\tconsole.error(\"Login error:\", err);\r\n\r\n\t\tif (err?.name === \"ValidationError\" && err.errors) {\r\n\t\t\tconst details: Record<string,string> = {};\r\n\t\t\tfor (const [k, v] of Object.entries(err.errors)) {\r\n\t\t\t\t// @ts-ignore\r\n\t\t\t\tdetails[k] = v.message || String(v);\r\n\t\t\t}\r\n\t\t\treturn NextResponse.json({ error: \"Validation error\", details }, { status: 400 });\r\n\t\t}\r\n\r\n\t\treturn NextResponse.json({ error: err?.message || \"Internal server error\" }, { status: 500 });\r\n\t}\r\n}\r\n"],"names":[],"mappings":"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"}}]
}